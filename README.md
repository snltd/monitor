# snltd-monitor

A lightweight fault monitor for small, zoned Solaris environments.

## Background

In 2007 I created a heavily virtualzed Solaris environment running
MySQL, Apache, webDAV, Subversion, Exim, Coldfusion and a bunch of other
stuff.

It was fairly early days for zones, and I couldn't find any monitoring
software that suited our needs particularly well. So, I wrote my own. We
ran this in production for three years, and found it produced excellent
results, with nothing important being missed, and very few false
positives. As ever, your mileage may vary.

Most of what's here is very site-specific, and I don't really expect
that anyone will use it. I do think though, that it's a good example of
clean, lightweight scripting.

## Installation and Usage

To get started, clone the repo, or unpack a release, into
`/usr/local/snltd_monitor`.

### `snltd_monitor.sh`

This script runs "classes" of checks. To see what checks are available,
either examining the contents of the `checks/` directory, or run

    $ snltd_monitor.sh -l

To run a class of checks, run

    # snltd_monitor.sh <class>

The magic class name `all` runs all checks known to the system.

When `snltd_monitor.sh` starts, it reads up to two configuration files.
First, `etc/config.global`. Second, if it exists,
`etc/config.<hostname>`. These files set and export shell variables.
Note: it's essential to `export`, as the checks are run in subshells.

If you wish a host to omit one or more checks, list them in the
`OMIT_SCRIPTS` variable.

You can run checks on-demand by executing `snltd_monitor.sh`, or
schedule things with `snltd_monitor_daemon.sh`.


### `snltd_monitor-daemon.sh`

This script runs as a daemon, managed by SMF, and calls
`snltd_monitor.sh` at set intervals, with different arguments.  You
define  a repeat interval for each class of tests with the `INT_<class>`
variable. You must uppercase the class name, and intervals are in
secods. For instance, if you wanted to test your operating system every
ten minutes and your hardware every hour, your config file would include

```sh
export INT_OS=600
export INT_HARDWARE=3600
```

You need to create an RBAC profile, and information on exactly how to do so
is in the header of the `mon_exec_wrapper.sh` script. There's an SMF manifest
in `lib/svc/manifest/` which will get things running.

You may not wish errors to be reported until they have been detected
more than once. For this, define a `REP_` variable.  Tag the name of the
check on to `REP_`, and assign it to a number. For instance, to only
report paging if it exceeds the allowed threshold on three consecutive
tests, define

```sh
export REP_paging=3
```

in your host (or global) config file.

Host files are sourced after the global, so global settings can be
overridden per-host.

## Checks

Checks are quite like Nagios checks: a program in any language which
exists with a specific code. Please see the `README.md` in `checks/` for
more details.

Many checks require variables to be set. These are all documented in
`checks/<class>/README.md`.

## What You Get

`snltd_monitor.sh` mails out with errors and warnings. The address can
be set on each invocation with `-m`, or by setting `MAILTO` in the main
script, or any config file. Multiple e-mail addresses can be used if
comma-separated.

There is also a plugin to [s-audit](https://github.com/snltd/s-audit)
which presents a site health check using the information generated by
this software, but I haven't yet ported it to the new versions of
s-audit.

## License

The client for whom this software was written no longer exists in any
form. After the company's dissolution my former manager agreed that
there was no problem releasing the code as open source.   All branding
and site-specific information has been removed.

